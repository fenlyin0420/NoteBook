# 认识TCP协议
TCP是**面向连接**的协议，这是因为在一个应用进程可以开始向另一个应用进程发送数据之前，这两个进程必须先相互“握手”，即它们必须相互发送某些预备报文段，以建立连接。它有以下几个特点：

- **面向连接**：TCP一定是“一对一”的，无法像 UDP 协议那样在同一时刻像多个主机发送消息，即无法做到一对多；
- **可靠的**：TCP 可以保证每一个报文一定能够到达接收端（接收端收到数据包后会发送ACK数据包），“可靠性”是相对可靠，即不考虑非正常情况，如网络线路中断等；
- **基于字节流**：消息是“没有边界”的，所以无论我们消息有多大都可以进行传输（**多次发送**）。并且消息是“**有序的**”，当前一个消息没有收到的时候，即使它先收到了后面的字节已经收到，那么也不能扔给应用层去处理，同时对重复的报文会自动丢弃（**去重**）。

# TCP数据包头部结构
![](1614350-20201209214135907-692951274.png)
- 【端口号】：端口号，用于多路复用或者分解来自（送到）上层的数据；
- 【序列号】：在连接建立时由计算机生成的初始值，通过 SYN 包传给对端主机，每发送一次新的数据包，就**累加**一次该序列号的大小。**用来解决网络包乱序问题**；
- 【确认应答号】：指下次期望收到的数据的序列号，发送端收到这个确认应答以后可以确认`确认应答号-1`的数据包已经被正常接收。主要**用来解决不丢包的问**；
- 【标志字段】：
    - 【ACK】：用以指示确认字段中的值是有效的，即该报文段包括一个对已被成功接收的报文段的确认；
    - 【RST】：用以指示连接的强制拆除，当接收到错误连接时会发送RST位置为1的报文；
    - 【SYN】：用以指示连接的建立，该位为1的报文表示希望建立连接；
    - 【FIN】：用以指示连接的终止，该位为1的报文表示希望断开连接；

# TCP建立连接（三次握手）
![](1614350-20201209214154676-1864706572.png)
## 三次握手流程
- 一开始客户端和服务端都处于CLOSED的状态。然后先是服务端主动监听某个端口，处于LISTEN状态；
- 【第一个报文】：客户端会随机初始化序列号（client_isn），将此序列号置于TCP首部的**序列号**字段中，同时将**SYN**标志位置为1，表示该报文为**SYN**报文。接下来就将第一个SYN报文发送给服务端，表示请求建立连接，该报文不包含应用层数据，之后客户端处于 SYN-SENT 状态。
- 【第二个报文】：服务端收到客户端的SYN报文后，首先服务端也随机初始化自己的序列号（server_isn），将此序号填入TCP首部的**序号**字段中，其次把 `client_isn + 1`填入TCP首部的**确认应答号**字段，接着把 SYN 和 ACK 标志位置为1，表示该报文为**SYN+ACK**报文。最后把该报文发给客户端，该报文也不包含应用层数据，之后服务端处于 SYN-RCVD 状态。
- 【第三个报文】：客户端收到服务端报文后，还要向服务端回应最后一个报文，首先应答报文 TCP 首部 ACK 标志位置为1，其次把`server_isn + 1`填入**确认应答号**字段 ，最后把报文发送给服务端，**这次报文可以携带客户端到服务器的数据**，之后客户端处于 **ESTABLISHED** 状态。
- 服务器收到客户端的应答报文后，也进入 **ESTABLISHED** 状态。

## 为什么是三次握手？
为什么TCP连接确立需要三次握手，而不是两次？还是四次？这是一个经常能被问到的问题。接下来就几个方面分析为什么需要三次握手的原因。
### 1. 避免历史连接（主要原因）
> The principle reason for the three-way handshake is to prevent old duplicate connection initiations from causing confusion.

上面文字出自 RFC 793，三次握手的主要原因是为了防止旧的重复连接初始化造成混乱。

网络环境是比较复杂的，它不一定能保证我们先发送的数据包就一定能再我们期望的时间内送达，它可能超时后再抵达服务端，那么这时的TCP就会产生以下的一种情况:

![](1614350-20201209214300158-1981683893.png)

如上图所示，如果一个SYN报文在超时后没有得到响应，客户端可能再次发送一个新的SYN请求，而这时旧的SYN请求可能比新的SYN请求先达到服务器。如果此时没有第三次连接来确认此次连接是否是历史连接的话，那么双方可能会建立两个连接，造成数据混乱。而如果是三次连接的话，客户端就有机会再去确认或者中止掉错误的连接，**防止历史连接建立从而建立多个连接**。

### 2. 避免资源浪费


>参考链接：
>1. https://www.cnblogs.com/jojop/p/14111160.html
